# Calendar Service

Учебный HTTP-сервис для управления событиями пользователей в формате календаря.  
Поддерживает CRUD-операции + выборку событий за определенный период.  
При запуске приложения данные считываются из файла и хранятся в оперативной 
памяти в конкурентном доступе, при завершении работы сохраняются в файл.

## Возможности

- Создание события
- Обновление события
- Удаление события
- Получение списка событий:
  - за день
  - за неделю
  - за месяц
- Валидация входных данных
- UID событий (UUID v4)
- Автосохранение/загрузка данных в JSON при старте/остановке сервера
- Простое логирование всех HTTP-запросов (middleware)

## Архитектура

Сервис разделён на три слоя:
- **handler** - парсинг запросов, формирование HTTP-ответов
- **service** - бизнес-логика, проверки входных данных, ошибки
- **repository** — работа с in-memory картой (map[user_id][]*Event)
Модель данных определена в пакете `model`, так же реализован 
пакет `config` для считывания переменных окружения из .env-файла. 
Считывание событий и их запись в файл реализована в пакете `storage`.

## Модели

### Event
```json
{
  "event_id": "UUID",
  "date": "2023-12-31",
  "event": "Новый год"
}
```
Так же в **model.Event** реализованф дополнительные поля:
- Created - время создания события,
- Updated - время обновления события
для расширения функциональности в будущем.

## Формат дат

Во входящих запросах дата всегда приходит в формате "YYYY-MM-DD" согласно заданию.
Внутри структуры используется тип CustomTime, умеющий парсить только этот формат.
При загрузке из файла сервис корректно распознаёт ISO-формат (2023-12-31T00:00:00Z).

## Запуск

```bash
go run cmd/server/main.go
```
По умолчанию сервер слушает порт 8080, если в .env не указан другой порт.

## Файл хранилища

При запуске сервис пытается загрузить карту событий из файла "eventsmap.txt", если иное название/путь не указаны в .env.
Если указанного файла не существует, сервис использует пустую карту для начала работы, а при завершении работы создает 
файл и сохраняет в него события из ОЗУ сериализуя в JSON.

## API list
1. Создать событие - POST /create_event
Формат JSON:
```json
{
  "user_id": 1,
  "date": "2023-12-31",
  "event": "Новый год"
}
```
Ответ 200 OK:
```json
{
  "event_id": "a18bb2fb-5beb-4b0c-b3e2-e9e5f9a01eef",
  "date": "2023-12-31",
  "event": "Новый год"
}
```
2. Обновить событие - POST /update_event (должно быть PATCH, но задание требует POST)
Формат JSON:
```json
{
  "user_id": 1,
  "event_id": "a18bb2fb-5beb-4b0c-b3e2-e9e5f9a01eef",
  "date": "2024-01-01",
  "event": "Перенос праздника"
}
```
Ответ 200 OK:
```json
{
  "event_id": "a18bb2fb-5beb-4b0c-b3e2-e9e5f9a01eef",
  "date": "2024-01-01",
  "event": "Перенос праздника"
}
```
3. Удалить событие - POST /delete_event (должно быть DELETE, но задание требует POST)
```json
{
  "user_id": 1,
  "event_id": "a18bb2fb-5beb-4b0c-b3e2-e9e5f9a01eef"
}
```
Ответы:
- 200 OK — успешно
- 503 — если события нет (должно быть 404, но задание требует 503)
- 400 — если параметры некорректны

4. Получить события за день

GET /events_for_day?user_id=1&date=2023-12-31

5. Неделя

GET /events_for_week?user_id=1&date=2023-12-31

6. Месяц

GET /events_for_month?user_id=1&date=2023-12-31

## Статус-коды

Сервис использует следующие коды ответа:
- 200 OK — успешные запросы
- 400 — ошибки ввода (некорректная дата, пустые поля и т. д.)
- 503 — ошибки бизнес-логики (например, удаление несуществующего события)
- 500 — системные ошибки

## Тестирование

Есть юнит-тесты для:
- service (мок репозитория)
- repository (чистая логика с map)
Команды запуска:
```bash
go test ./...
```
```bash
go test ./internal/service/...
```
```bash
go test ./internal/repository/...
```

Примеры cURL-запросов:
- создание события:
```bash
curl -X POST http://localhost:8080/create_event \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "date": "2025-01-01",
    "event": "Научиться писать тесты"
  }'
```
- обновление события:
```bash
curl -X POST http://localhost:8080/update_event \
  -H "Content-Type: application/json" \
  -d '{
    "event_id": "PUT-YOUR-UUID-HERE",
    "user_id": 1,
    "date": "2025-01-02",
    "event": "Обновлённая задача"
  }'
```
- удаление события:
```bash
curl -X POST http://localhost:8080/delete_event \
  -H "Content-Type: application/json" \
  -d '{
    "event_id": "PUT-YOUR-UUID-HERE",
    "user_id": 1
  }'
```
- получить события на день:
```bash
curl -X GET "http://localhost:8080/events_for_day?user_id=1&date=2025-01-01"
```
- получить события на неделю:
```bash
curl -X GET "http://localhost:8080/events_for_week?user_id=1&date=2025-01-01"
```
- получить события на месяц:
```bash
curl -X GET "http://localhost:8080/events_for_month?user_id=1&date=2025-01-01"
```

## Зависимости

github.com/go-chi/chi/v5 — роутер
github.com/google/uuid — генерация UUID
